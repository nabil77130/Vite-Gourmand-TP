{% extends 'base.html.twig' %}

{% block title %}Notre Carte — Vite & Gourmand{% endblock %}

{% block body %}
<div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 2rem;">
    <h1 style="font-size:2.2rem;font-weight:700;margin-bottom:0.5rem;"><i class="fa-solid fa-utensils"></i> Notre Carte</h1>
    <p style="color:#6b7280;margin-bottom:3rem;">Découvrez nos menus de traiteur et la composition de chaque plat.</p>

    {# ── MENUS ── #}
    {% if menus %}
        <div class="category-section" style="margin-bottom: 4rem;">
            <h2 style="border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: inline-block; margin-bottom: 2rem;">
                <i class="fa-solid fa-star"></i> Nos Menus
            </h2>
            <div class="products-grid" style="padding: 0;">
                {% for menu in menus %}
                    <div class="product-card glass" style="border: 2px solid var(--primary-color);">
                        {% set mainDish = menu.products|filter(p => p.category == 'main')|first %}
                        {# Priority: Menu Image > Main Dish Image > First Product Image > Placeholder #}
                        {% set displayImage = menu.imageName ? 'menus/' ~ menu.imageName : (mainDish ? 'products/' ~ mainDish.imageName : (menu.products|length > 0 ? 'products/' ~ menu.products[0].imageName : null)) %}
                        
                        {% if displayImage %}
                            <img src="{{ asset('images/' ~ displayImage) }}" alt="{{ menu.name }}" style="width:100%;height:200px;object-fit:cover;border-radius:1rem 1rem 0 0;">
                        {% else %}
                            <img src="https://placehold.co/600x400/15803D/FFFFFF?text={{ menu.name|url_encode }}" alt="{{ menu.name }}" style="width:100%;height:200px;object-fit:cover;border-radius:1rem 1rem 0 0;">
                        {% endif %}
                        <div class="product-details">
                            <h3>{{ menu.name }}</h3>
                            <p>{{ menu.description }}</p>
                            <ul style="list-style: none; padding: 0; margin: 1rem 0;">
                                {% for product in menu.products %}
                                    <li style="padding: 0.2rem 0; color: #6B7280; font-size: 0.9rem;">• {{ product.name }}</li>
                                {% endfor %}
                            </ul>
                            <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                                {% if menu.minPeople %}
                                    <span style="background: rgba(16,185,129,0.15); color: var(--primary-color); font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 999px; font-weight: 600;"><i class="fa-solid fa-users"></i> Min. {{ menu.minPeople }} pers.</span>
                                {% endif %}
                                {% if menu.stock is not null %}
                                    <span style="background: {% if menu.stock > 0 %}rgba(16,185,129,0.15){% else %}rgba(239,68,68,0.15){% endif %}; color: {% if menu.stock > 0 %}var(--primary-color){% else %}#EF4444{% endif %}; font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 999px; font-weight: 600;">
                                        {% if menu.stock > 0 %}<i class="fa-solid fa-box"></i> {{ menu.stock }} dispo.{% else %}<i class="fa-solid fa-xmark"></i> Épuisé{% endif %}
                                    </span>
                                {% endif %}
                            </div>
                            <div class="product-price">{{ menu.price }} €<span style="font-size:0.8rem;font-weight:400;color:#9ca3af;"> / pers.</span></div>
                            <a href="{{ path('app_menu_show', {'id': menu.id}) }}" class="btn btn-primary" style="width: 100%; margin-top: 1rem; display: block; text-align: center;">Voir le détail &amp; Commander →</a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    {# ── PLATS PAR CATÉGORIE (informatif seulement) ── #}
    <div style="background:rgba(99,102,241,0.05);border:1px solid rgba(99,102,241,0.15);border-radius:1rem;padding:1.25rem;margin-bottom:2rem;">
        <p style="margin:0;color:#6b7280;font-size:0.9rem;"><i class="fa-solid fa-circle-info"></i> Les plats ci-dessous sont présentés à titre informatif. Ils font partie de nos menus. Pour commander, sélectionnez un menu ci-dessus.</p>
    </div>

    {% for category, products in groupedProducts %}
        <div class="category-section" style="margin-bottom: 4rem;">
            <h2 style="border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; display: inline-block; margin-bottom: 2rem;">
                {% if category == 'starter' %}<i class="fa-solid fa-carrot"></i> Entrées
                {% elseif category == 'main' %}<i class="fa-solid fa-utensils"></i> Plats principaux
                {% elseif category == 'dessert' %}<i class="fa-solid fa-cake-candles"></i> Desserts
                {% elseif category == 'drink' %}<i class="fa-solid fa-glass-water"></i> Boissons
                {% else %}{{ category|capitalize }}s{% endif %}
            </h2>

            <div class="products-grid" style="padding: 0;">
                {% for product in products %}
                    <div class="product-card glass">
                        {% if product.imageName %}
                            <img src="{{ asset('images/products/' ~ product.imageName) }}" alt="{{ product.name }}" class="product-image">
                        {% else %}
                            <img src="https://placehold.co/400x300?text={{ product.name|url_encode }}" alt="{{ product.name }}" class="product-image">
                        {% endif %}
                        <div class="product-details">
                            <h3>{{ product.name }}</h3>
                            <p>{{ product.description }}</p>

                            {% if product.diets|length > 0 %}
                            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-bottom:0.5rem;">
                                {% for diet in product.diets %}
                                    <span style="background:rgba(16,185,129,0.15);color:#059669;padding:0.2rem 0.5rem;border-radius:12px;font-size:0.75rem;font-weight:600;"><i class="fa-solid fa-leaf"></i> {{ diet.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if product.allergens|length > 0 %}
                            <div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-bottom:0.5rem;">
                                {% for allergen in product.allergens %}
                                    <span style="background:rgba(239,68,68,0.12);color:#dc2626;padding:0.2rem 0.5rem;border-radius:12px;font-size:0.75rem;font-weight:600;"><i class="fa-solid fa-triangle-exclamation"></i> {{ allergen.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <div class="product-price">{{ product.price }} €</div>
                            <p style="font-size:0.8rem;color:#9ca3af;margin-top:0.75rem;font-style:italic;">Disponible dans nos menus</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <p>Aucun plat disponible pour le moment.</p>
    {% endfor %}
</div>
{% endblock %}

