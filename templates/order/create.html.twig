{% extends 'base.html.twig' %}
{% block title %}Commander ‚Äî {{ menu.name }}{% endblock %}
{% block body %}
<div style="max-width:800px;margin:2rem auto;padding:0 1rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
        <h1 style="font-size:1.8rem;font-weight:700;">üõí Commander : {{ menu.name }}</h1>
        <a href="{{ path('app_menu_show', {id: menu.id}) }}" style="color:#6b7280;text-decoration:none;">‚Üê Retour au menu</a>
    </div>

    {# Menu summary #}
    <div style="background:linear-gradient(135deg,rgba(16,185,129,0.08),rgba(99,102,241,0.08));border:1px solid rgba(16,185,129,0.2);border-radius:1rem;padding:1.25rem;margin-bottom:1.5rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
                <h3 style="margin:0 0 0.25rem;">{{ menu.name }}</h3>
                <p style="color:#6b7280;margin:0;font-size:0.9rem;">{{ menu.description }}</p>
            </div>
            <div style="text-align:right;">
                <div style="font-size:1.5rem;font-weight:800;color:var(--secondary-color);">{{ menu.price }} ‚Ç¨</div>
                {% if menu.minPeople %}<div style="font-size:0.85rem;color:#9ca3af;">min. {{ menu.minPeople }} personnes</div>{% endif %}
            </div>
        </div>
    </div>

    {# Client info (pre-filled) #}
    <div style="background:white;border-radius:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:1.5rem;margin-bottom:1.5rem;">
        <h3 style="margin-bottom:1rem;font-size:1rem;color:#6b7280;text-transform:uppercase;letter-spacing:0.05em;">Vos informations (pr√©-remplies)</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;font-size:0.95rem;">
            <div><strong>Nom :</strong> {{ user.firstName }} {{ user.lastName }}</div>
            <div><strong>Email :</strong> {{ user.email }}</div>
            <div><strong>T√©l√©phone :</strong> {{ user.phone ?? '‚Äî' }}</div>
        </div>
    </div>

    {# Order form #}
    <div style="background:white;border-radius:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:1.5rem;margin-bottom:1.5rem;">
        <h3 style="margin-bottom:1.25rem;">D√©tails de la prestation</h3>
        {{ form_start(form, {attr: {id: 'order-form'}}) }}
        <div style="display:grid;gap:1.25rem;">
            <div>{{ form_label(form.adressePrestation) }}{{ form_widget(form.adressePrestation, {attr: {class: 'form-control', id: 'adresse-input'}}) }}{{ form_errors(form.adressePrestation) }}
                <small style="color:#9ca3af;">‚ö†Ô∏è Livraison hors Bordeaux : 5‚Ç¨ + 0,59‚Ç¨/km</small>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div>{{ form_label(form.eventDate) }}{{ form_widget(form.eventDate, {attr: {class: 'form-control'}}) }}{{ form_errors(form.eventDate) }}</div>
                <div>{{ form_label(form.deliveryTime) }}{{ form_widget(form.deliveryTime, {attr: {class: 'form-control'}}) }}{{ form_errors(form.deliveryTime) }}</div>
            </div>
            <div>
                {{ form_label(form.nombrePersonne) }}
                {{ form_widget(form.nombrePersonne, {attr: {class: 'form-control', id: 'nombre-personnes', min: menu.minPeople ?? 1}}) }}
                {{ form_errors(form.nombrePersonne) }}
            </div>
        </div>
        {{ form_end(form) }}
    </div>

    {# Price summary (dynamic) #}
    <div id="price-summary" style="background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(16,185,129,0.08));border:1px solid rgba(99,102,241,0.2);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem;">
        <h3 style="margin-bottom:1rem;">üí∞ R√©capitulatif du prix</h3>
        <div style="display:grid;gap:0.5rem;font-size:0.95rem;">
            <div style="display:flex;justify-content:space-between;"><span>Prix du menu :</span><strong id="prix-menu">{{ menu.price }} ‚Ç¨</strong></div>
            <div style="display:flex;justify-content:space-between;" id="remise-row" style="display:none;"><span>R√©duction 10% (‚â• {{ (menu.minPeople ?? 1) + 5 }} pers.) :</span><strong id="remise-val" style="color:#10b981;">- 0 ‚Ç¨</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Livraison :</span><strong id="prix-livraison">0 ‚Ç¨</strong></div>
            <hr style="border:none;border-top:1px solid rgba(99,102,241,0.2);margin:0.5rem 0;">
            <div style="display:flex;justify-content:space-between;font-size:1.2rem;"><span><strong>Total :</strong></span><strong id="total-price" style="color:var(--secondary-color);">{{ menu.price }} ‚Ç¨</strong></div>
        </div>
    </div>

    <button type="submit" form="order-form" class="btn btn-primary" style="width:100%;padding:1rem;font-size:1.1rem;">‚úÖ Confirmer la commande</button>
</div>

<script>
const menuPrice = {{ menu.price ?? 0 }};
const minPeople = {{ menu.minPeople ?? 1 }};

function updatePrice() {
    const n = parseInt(document.getElementById('nombre-personnes').value) || minPeople;
    const adresse = document.getElementById('adresse-input').value.toLowerCase();

    let remise = 0;
    if (n >= minPeople + 5) {
        remise = menuPrice * 0.10;
    }

    let livraison = 0;
    if (adresse && !adresse.includes('bordeaux')) {
        livraison = 5.0;
    }

    const total = (menuPrice - remise) + livraison;

    document.getElementById('prix-menu').textContent = menuPrice.toFixed(2) + ' ‚Ç¨';
    document.getElementById('remise-val').textContent = '- ' + remise.toFixed(2) + ' ‚Ç¨';
    document.getElementById('remise-row').style.display = remise > 0 ? 'flex' : 'none';
    document.getElementById('prix-livraison').textContent = livraison.toFixed(2) + ' ‚Ç¨';
    document.getElementById('total-price').textContent = total.toFixed(2) + ' ‚Ç¨';
}

document.getElementById('nombre-personnes').addEventListener('input', updatePrice);
document.getElementById('adresse-input').addEventListener('input', updatePrice);
updatePrice();
</script>
{% endblock %}
